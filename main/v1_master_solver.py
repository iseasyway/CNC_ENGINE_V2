# -*- coding: utf-8 -*-
"""
v1_master_solver.py
============================================================
ğŸ§  èˆªæ¯ä¸­å¤®å¤§è…¦ï¼ˆV1 ç‰ˆæœ¬ï¼‰

è§’è‰²å®šä½ï¼š
- ä½œç‚º V1 å¹¾ä½•è¨ˆç®—çš„ã€Œå”¯ä¸€ç¸½å…¥å£ã€
- çµ±ä¸€èª¿åº¦å››å¤§åŠ å·¥å» ï¼ˆA / B / C / Dï¼‰
- æ§åˆ¶æ¨¡çµ„åŸ·è¡Œé †åºèˆ‡è³‡æ–™æµå‘
- æä¾› app.py å‘¼å«çš„ç©©å®šé‹ç®—ä»‹é¢

è¨­è¨ˆåŸå‰‡ï¼š
- æœ¬æª”æ¡ˆä¸å¯«ä»»ä½•å¹¾ä½•å…¬å¼
- åªè² è²¬ã€Œèª¿åº¦ã€ä¸²æ¥ã€æ•´åˆã€
- å„å·¥å» å…§éƒ¨é‚è¼¯å®Œå…¨ç¨ç«‹
============================================================
"""

import importlib


# ------------------------------------------------------
# ğŸ”§ æŒ‡å®šç›®å‰ä½¿ç”¨çš„å…¬å¼ç‰ˆæœ¬
# ------------------------------------------------------
# èªªæ˜ï¼š
# - æ‰€æœ‰å¹¾ä½•å…¬å¼éƒ½æ”¾åœ¨ main.formulas åº•ä¸‹
# - é€éç‰ˆæœ¬å­—ä¸²æ§åˆ¶ï¼ˆv1 / v2 / v3â€¦ï¼‰
# - é€™æ”¯ master solver å°ˆå±¬æ–¼ v1
#
# å¥½è™•ï¼š
# - æœªä¾†æ–°å¢ v2ï¼Œåªéœ€è¤‡è£½æœ¬æª”ä¸¦æ”¹ç‰ˆæœ¬
# - app.py å¹¾ä¹ä¸ç”¨å‹•
# ------------------------------------------------------
FORMULA_VERSION = "v1"
formula_path = f"main.formulas.{FORMULA_VERSION}"


# ------------------------------------------------------
# ğŸ“¦ å‹•æ…‹åŒ¯å…¥å››å¤§åŠ å·¥å» æ¨¡çµ„
# ------------------------------------------------------
# èªªæ˜ï¼š
# - ä½¿ç”¨ importlib å‹•æ…‹è¼‰å…¥
# - é¿å…å¯«æ­» importï¼Œæ–¹ä¾¿ç‰ˆæœ¬åˆ‡æ›
#
# å››å¤§åŠ å·¥å» è·è²¬æ¦‚å¿µï¼š
# Aï¼šå‰ç«¯åœ“è§’ / åˆå§‹å¹¾ä½•å»ºç«‹
# Bï¼šå¤–å¾‘ / å‚ç›´ / è£œæ­£é¡è¨ˆç®—
# Cï¼šæ–œç·š + çµ‚é»ç·š + åœ“å¼§æ•´åˆ
# Dï¼šè§’åº¦ â†’ Z è»¸ä½ç§» / ä¿®æ­£é‡
# ------------------------------------------------------
module_a = importlib.import_module(
    f"{formula_path}.module_a_front_fillet"
)
module_b = importlib.import_module(
    f"{formula_path}.module_b_outer_perp_R"
)
module_c = importlib.import_module(
    f"{formula_path}.module_c_front_slope_endline_arc_v1"
)
module_d = importlib.import_module(
    f"{formula_path}.module_d_angle_to_z_offset"
)


# ==========================================================
# ğŸ§  ä¸»é‹ç®—æµç¨‹ï¼šæ•´åˆ A + B + C + D
# ==========================================================
def run_all_modules(user_inputs: dict):
    """
    ä¸»é‹ç®—æµç¨‹ï¼ˆV1ï¼‰ï¼š

    è¼¸å…¥ï¼š
    - user_inputsï¼šç”±å‰ç«¯å‚³å…¥çš„åŸå§‹åƒæ•¸ dict

    æµç¨‹ï¼š
    1ï¸âƒ£ è¤‡è£½è¼¸å…¥è³‡æ–™ï¼Œé¿å…æ±¡æŸ“åŸå§‹è³‡æ–™
    2ï¸âƒ£ ä¾åºåŸ·è¡Œ A â†’ B â†’ C â†’ D
    3ï¸âƒ£ æ”¶é›†å„å·¥å» å›å‚³çš„ values
    4ï¸âƒ£ å›å‚³å®Œæ•´çµæœ dict

    è¼¸å‡ºï¼š
    - results = {
        "A": {...},
        "B": {...},
        "C": {...},
        "D": {...}
      }
    """

    # --------------------------------------------------
    # å»ºç«‹å…§éƒ¨è³‡æ–™å‰¯æœ¬
    # --------------------------------------------------
    # åŸå‰‡ï¼š
    # - ä¸ç›´æ¥ä¿®æ”¹ user_inputs
    # - ä¸­å¤® data ä½œç‚ºã€Œæµå‹•è³‡æ–™åŒ…ã€
    data = user_inputs.copy()

    # æœ€çµ‚çµæœå®¹å™¨
    results = {}


    # --------------------------
    # ğŸ­ A å·¥å» 
    # --------------------------
    # åŠŸèƒ½ï¼š
    # - å‰ç«¯åœ“è§’ / åˆå§‹å¹¾ä½•è¨ˆç®—
    # - å»ºç«‹å¾ŒçºŒå·¥å» æ‰€éœ€çš„åŸºæº–å¹¾ä½•
    #
    # ç‰¹é»ï¼š
    # - å›å‚³æ ¼å¼ç‚º dict
    # - çœŸæ­£æ•¸å€¼æ”¾åœ¨ key="values"
    res_a = module_a.calc_front_fillet_from_direct_inputs(data)

    results["A"] = res_a.get("values", {})

    # A çš„çµæœæœƒè¢« C å·¥å» ä½¿ç”¨
    # å› æ­¤å¯«å› data ä¾›å¾ŒçºŒæ¨¡çµ„å–ç”¨
    data["A"] = results["A"]


    # --------------------------
    # ğŸ­ B å·¥å» 
    # --------------------------
    # åŠŸèƒ½ï¼š
    # - å¤–å¾‘ / å‚ç›´é—œä¿‚ / R è£œæ­£è¨ˆç®—
    # - å¤šç‚ºç¨ç«‹è¨ˆç®—ï¼Œä¸å½±éŸ¿å…¶ä»–å·¥å» 
    res_b = module_b.solve(data)
    results["B"] = res_b.get("values", {})


    # --------------------------
    # ğŸ­ C å·¥å» 
    # --------------------------
    # åŠŸèƒ½ï¼š
    # - æ–œç·š + çµ‚é»ç·š + åœ“å¼§æ•´åˆ
    # - æœƒä½¿ç”¨ A å·¥å» ç”¢ç”Ÿçš„åŸºæº–å¹¾ä½•
    res_c = module_c.solve(data)
    results["C"] = res_c.get("values", {})


    # --------------------------
    # ğŸ­ D å·¥å» 
    # --------------------------
    # åŠŸèƒ½ï¼š
    # - è§’åº¦è½‰ Z è»¸ä½ç§»
    # - è£œæ­£é‡è¨ˆç®—
    #
    # å‚™è¨»ï¼š
    # - æ­¤å·¥å» æ­£ç¢ºå…¥å£ç‚º solve(data)
    res_d = module_d.solve(data)
    results["D"] = res_d.get("values", {})

    return results


# ==========================================================
# ğŸ”¥ çµ±ä¸€è¼¸å‡ºæ ¼å¼ï¼ˆçµæœ dict â†’ HTMLï¼‰
# ==========================================================
def render_output(results: dict) -> str:
    """
    å°‡ run_all_modules çš„çµæœè½‰ç‚º HTML å­—ä¸²

    ç”¨é€”ï¼š
    - ç›´æ¥å›å‚³çµ¦å‰ç«¯é¡¯ç¤º
    - é¿å…å‰ç«¯å†è™•ç†è³‡æ–™æ ¼å¼

    é¡¯ç¤ºæ–¹å¼ï¼š
    - ä½¿ç”¨ <pre> ä¿æŒç­‰å¯¬å°é½Š
    - ä¾å·¥å» åˆ†é¡è¼¸å‡º
    """

    html = ["<pre>"]

    for key, val in results.items():
        html.append(f"ğŸ”¹ {key} å·¥å» çµæœï¼š")

        for k, v in val.items():
            html.append(f"  {k} = {v}")

        html.append("")

    html.append("</pre>")
    return "\n".join(html)


# ==========================================================
# ğŸ›  é–‹ç™¼æ¨¡å¼ï¼šå‹•æ…‹ç†±æ›´æ–°
# ==========================================================
def reload_all():
    """
    é‡æ–°è¼‰å…¥å››å¤§åŠ å·¥å» æ¨¡çµ„

    ä½¿ç”¨æ™‚æ©Ÿï¼š
    - é–‹ç™¼éšæ®µä¿®æ”¹ module A/B/C/D
    - ä¸æƒ³é‡å•Ÿ FastAPI / Uvicorn
    """

    importlib.reload(module_a)
    importlib.reload(module_b)
    importlib.reload(module_c)
    importlib.reload(module_d)
