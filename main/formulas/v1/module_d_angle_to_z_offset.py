# -*- coding: utf-8 -*-
"""
module_d_angle_to_z_offset.py
============================================================
🏭 D 工廠：角度 → Z 軸距離（B14）

角色定位：
- 將「加工角度」轉換為「Z 軸補正距離」
- 常用於刀鼻半徑補正的 Z 向位移
- 對應你 Excel / 工廠中的 B14 欄位

特性：
- 獨立模組
- 不依賴 A / B / C 工廠
- 可單獨使用，也可被航母主控串接
============================================================
"""

import math


# -------------------------------------------------------
# 🔧 顯示用格式化工具
# -------------------------------------------------------
def _fmt(x, p=6):
    """
    數值顯示格式化
    - 預設小數點後 6 位
    - None 時顯示為 "-"
    """
    return f"{x:.{p}f}" if x is not None else "-"


# -------------------------------------------------------
# 🧠 核心計算（D 工廠）
# -------------------------------------------------------
def solve(data):
    """
    D 工廠主計算函式

    輸入 data：
    {
        "角度": ,        # 加工角度（deg）
        "刀鼻半徑": ,     # 刀鼻半徑
    }

    幾何意義：
    - 依據加工角度 θ
    - 計算刀鼻半徑在 Z 方向所造成的位移
    - 輸出 B14（Z 軸補正距離，取正值）
    """

    # ===================================================
    # 1️⃣ 讀取輸入
    # ===================================================
    theta = float(data["角度"])        # 加工角度（deg）
    nose_r = float(data["刀鼻半徑"])   # 刀鼻半徑

    # ===================================================
    # ★ 防呆檢查：角度不能為 0°
    # ---------------------------------------------------
    # 原因：
    # - tan(0) = 0 → 分母為 0，幾何無意義
    # ===================================================
    if abs(theta) < 1e-12:
        raise ValueError("D 工廠錯誤：角度不能為 0°")

    # ===================================================
    # 2️⃣ 原始幾何公式（完全沿用工廠 / Excel）
    # ---------------------------------------------------
    # t = tan(theta)
    # s = sqrt(1 + t^2)  → 法向量長度
    #
    # B9  = 刀鼻在斜線法向的位移
    # B12 = Z 軸方向的有效位移
    # B14 = Z 軸補正距離（取絕對值）
    # ===================================================
    t = math.tan(math.radians(theta))
    s = math.sqrt(1.0 + t**2)

    B9 = nose_r * (s - 1.0) / t
    B12 = B9 - nose_r
    B14 = abs(B12)

    # ===================================================
    # 3️⃣ 航母統一輸出
    # ===================================================
    values = {
        "B14": B14
    }

    text_lines = [
        "➡️ D 工廠：角度 → Z軸距離 B14",
        f"B14 = {_fmt(B14)}"
    ]

    return {
        "ok": True,
        "text_lines": text_lines,
        "values": values
    }
