# -*- coding: utf-8 -*-
"""
module_c_front_slope_endline_arc_v1.py
============================================================
🏭 C 工廠：前端斜角 → 終點平線 → 終點圓弧（V1）

角色定位：
- 承接 A 工廠的「前端幾何基準」
- 計算斜線 → 平線 → 終點 R 圓弧 的完整銜接
- 屬於 V1 系統中「幾何關係最複雜」的模組

資料依賴：
- 必須由 A 工廠先行計算
- 使用 A 工廠輸出的 B7（小徑 X 起點）

輸出：
- E2 ~ E6：對齊 Excel / 加工圖面的關鍵座標與半徑
- 統一航母格式（values + text_lines）
============================================================
"""

import math


# -------------------------------------------------------
# 🔧 顯示用格式化工具
# -------------------------------------------------------
def _fmt(x, p=6):
    """
    數值顯示格式化
    - 預設小數點後 6 位
    - None 則顯示為 "-"
    """
    return f"{x:.{p}f}" if x is not None else "-"


# -------------------------------------------------------
# 🧠 核心計算（C 工廠）
# -------------------------------------------------------
def solve(data):
    """
    C 工廠主運算流程

    輸入 data（來自航母主控）：
    - data["A"]["B7"]        → 前端小徑 X 起點
    - data["角度"]           → 斜角角度
    - data["前端x軸外徑"]     → 外徑（直徑）
    - data["未端R角"]        → 終點 R
    - data["刀鼻半徑"]        → 刀鼻半徑

    輸出：
    - E2, E3：終點 R 起始點
    - E4, E5：終點 R 結束點
    - E6     ：刀鼻補正後圓弧 R
    """

    # ===================================================
    # 🔥 A 工廠資料注入
    # ---------------------------------------------------
    # A 工廠已先計算完成，並將 B7 寫入 data["A"]
    # B7 是本工廠的「幾何起點」
    # ===================================================
    A_values = data.get("A", {})
    B7 = A_values.get("B7")

    # ===================================================
    # 1️⃣ 讀取並整理輸入（對齊 Excel B 欄）
    # ===================================================
    B2 = float(B7)                           # 小徑 X（A 工廠）
    B3 = float(data["角度"])                 # 斜角角度（deg）
    B4 = float(data["前端x軸外徑"]) / 2       # 外徑半徑
    B5 = float(data["未端R角"])              # 終點 R
    B6 = float(data["刀鼻半徑"]) * 2          # 刀鼻直徑
    B8 = 0.0                                 # 平線 Z = 0（固定）

    # ===================================================
    # 2️⃣ 斜線基本參數（完全沿用原工廠公式）
    # ===================================================
    B10 = -math.tan(math.radians(B3))        # 斜線斜率
    B11 = B2 - B10 * B8                      # 斜線截距
    B12 = math.sqrt(1.0 + B10**2)            # 法向量長度

    B13 = B6 / 2.0                           # 刀鼻半徑
    B14 = B5 + B13                           # R + 刀鼻
    B16 = B4 - B5                            # 終點 R 圓心 X

    # ===================================================
    # 3️⃣ 第一個圓：斜線 × 終點 R（未補正）
    # ---------------------------------------------------
    # 解直線與圓的交點，取正確接觸點
    # ===================================================
    B17 = (B16 - B11 + B5 * B12) / B10
    B20 = 1.0 + B10**2
    B21 = 2.0 * (B10 * (B11 - B16) - B17)
    B22 = B17**2 + (B11 - B16)**2 - B5**2
    B23 = B21**2 - 4.0 * B20 * B22
    sqrt_B23 = math.sqrt(max(0.0, B23))

    B24 = (-B21 - sqrt_B23) / (2.0 * B20)
    B25 = (-B21 + sqrt_B23) / (2.0 * B20)
    B26 = B10 * B24 + B11
    B27 = B10 * B25 + B11

    # 選擇正確的交點
    if B24 < B25:
        B28, B29 = B24, B26
    else:
        B28, B29 = B25, B27

    # ===================================================
    # 4️⃣ 第二個圓：刀鼻補正後圓
    # ---------------------------------------------------
    # 與第一個圓接續，用距離判斷正確解
    # ===================================================
    B32 = B11 + B13 * B12
    B33 = 1.0 + B10**2
    B34 = 2.0 * (B10 * (B32 - B16) - B17)
    B35 = B17**2 + (B32 - B16)**2 - B14**2
    B36 = B34**2 - 4.0 * B33 * B35
    sqrt_B36 = math.sqrt(max(0.0, B36))

    B37 = (-B34 - sqrt_B36) / (2.0 * B33)
    B38 = (-B34 + sqrt_B36) / (2.0 * B33)
    B39 = B10 * B37 + B32
    B40 = B10 * B38 + B32

    # ===================================================
    # 5️⃣ E2, E3：終點 R 起始點
    # ---------------------------------------------------
    # 以距離判斷與第一圓銜接最合理者
    # ===================================================
    d1 = (B37 - B28)**2 + (B39 - B29)**2
    d2 = (B38 - B28)**2 + (B40 - B29)**2
    
    B51 = B37 if d1 <= d2 else B38
    B41 = B51-B13

    B52 = B39 if abs(B51 - B37) < 1e-12 else B40
    B42 = (B52-B13)*2
    # ===================================================
    # 6️⃣ E4, E5：終點 R 結束點（平線）
    # ===================================================
    B55 = B4 + B13                           # 終點 X
    B45 = (B55-B13)*2
    inside = max(0.0, B14**2 - (B55 - B16)**2)
    B56 = B17 - math.sqrt(inside)            # 終點 Z
    B46 = B56-B13
    B47 = B5 + (B6 / 2)                      # 刀鼻補正後 R
    
    # ===================================================
    # 7️⃣ 航母統一輸出
    # ===================================================
    result_values = {
        "E2": B41,
        "E3": B42,
        "E4": B46,
        "E5": B45,
        "E6": B47
    }

    text_lines = [
        "➡️ 前端斜角 → 平線 → 終點弧（C 工廠）",
        f"E2 = {_fmt(B41)}",
        f"E3 = {_fmt(B42)}",
        f"E4 = {_fmt(B46)}",
        f"E5 = {_fmt(B45)}",
        f"E6 = {_fmt(B47)}",
    ]

    return {
        "ok": True,
        "text_lines": text_lines,
        "values": result_values
    }
