# -*- coding: utf-8 -*-
"""
module_b_outer_perp_R.py
============================================================
🏭 B 工廠：外圓垂直端 R角計算

角色定位：
- 計算「外圓 + 垂直端面」的 R 角幾何
- 專注於 Z 方向端面與 X 外徑的關係
- 屬於「獨立工廠」，不依賴 A / C 工廠輸出

使用情境：
- CNC 外圓加工
- 垂直端面 R 角 + 刀鼻半徑補正

輸出特性：
- 統一航母格式（values + text_lines）
- 可直接被 v1_solver / master_solver 串接
============================================================
"""

import math


def solve(data):
    """
    B 工廠主運算函式

    輸入資料 data：
    {
        "前端x軸外徑": ,   # 外徑（直徑）
        "z軸長度": ,       # Z 軸端面位置
        "R角": ,           # 端面 R 角
        "刀鼻半徑": ,       # 刀鼻半徑
    }

    輸出：
    {
      ok: True,
      text_lines: [...],   # CLI / Debug 顯示
      values: {...}        # 航母統一輸出
    }
    """

    # ==================================================
    # 1️⃣ 讀取並整理輸入（對齊 Excel B 系列）
    # --------------------------------------------------
    # 說明：
    # - 所有輸入皆轉為 float
    # - 外徑一律轉為半徑計算
    # ==================================================
    B2 = float(data["前端x軸外徑"]) / 2          # 外圓半徑
    B3 = float(data["z軸長度"])                  # Z 軸端面
    B5 = float(data["R角"])                      # 端面 R
    nose_r = float(data["刀鼻半徑"])             # 刀鼻半徑

    B6 = nose_r * 2                              # 刀鼻直徑
    B9 = B6 / 2                                 # 刀鼻半徑（與 nose_r 等價）


    # ==================================================
    # 2️⃣ 幾何核心計算（完全沿用你原本的工廠公式）
    # --------------------------------------------------
    # 幾何意義說明：
    # - E3：前端 R 圓弧在 Z 軸的位置
    # - E6：刀鼻補正後，後端 Z 座標
    # - E7：後端 X 座標（外圓 + R）
    # - E9：刀鼻補正後的有效 R
    #
    # ⚠️ 不做任何幾何判斷，只單純代公式
    # ==================================================
   
    E53 = B3 - B5       # 前端 Z（端面 R 起點）
    E3 =  E53+B9
    E4 =  B2*2      # 中間 X（x座標）
    
    E6 =  B3        # 後端 Z（刀鼻補正）
    E57 = B2 + B5       # 後端 X
    E7 = (E57-B9)*2
    E9 = B5 - B9       # 刀鼻補正後有效 R


    # ==================================================
    # 3️⃣ 整理為「航母標準輸出格式」
    # --------------------------------------------------
    # text_lines：
    # - 給 Terminal / Debug 使用
    # - 幫助人工驗算、對照 Excel
    # ==================================================
    text_lines = [
        "➡️ 外圓垂直端 R角運算結果（B 工廠）",
        f"E3（前端 Z） = {E3:.6f}",
        f"E4（中間值 X） = {E4:.6f}",
        f"E6（後端 Z） = {E6:.6f}",
        f"E7（後端 X） = {E7:.6f}",
        f"E9（刀鼻補正 R） = {E9:.6f}",
    ]


    # ==================================================
    # 4️⃣ 統一 values 輸出（給航母主控使用）
    # --------------------------------------------------
    # key 命名說明：
    # - 使用 OUT_ 前綴，避免與其他工廠衝突
    # - master / solver 可直接取用
    # ==================================================
    result_values = {
        "OUT_E3": E3,
        "OUT_E4": E4,   # 保留欄位（目前 master 未使用）
        "OUT_E6": E6,
        "OUT_E7": E7,
        "OUT_E9": E9,
    }

    return {
        "ok": True,
        "text_lines": text_lines,
        "values": result_values
    }
