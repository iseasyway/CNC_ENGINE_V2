# -*- coding: utf-8 -*-
"""
module_c_front_slope_endline_arc_v1.py
============================================================
ğŸ­ C å·¥å» ï¼šå‰ç«¯æ–œè§’ â†’ çµ‚é»å¹³ç·š â†’ çµ‚é»åœ“å¼§ï¼ˆV1ï¼‰

è§’è‰²å®šä½ï¼š
- æ‰¿æ¥ A å·¥å» çš„ã€Œå‰ç«¯å¹¾ä½•åŸºæº–ã€
- è¨ˆç®—æ–œç·š â†’ å¹³ç·š â†’ çµ‚é» R åœ“å¼§ çš„å®Œæ•´éŠœæ¥
- å±¬æ–¼ V1 ç³»çµ±ä¸­ã€Œå¹¾ä½•é—œä¿‚æœ€è¤‡é›œã€çš„æ¨¡çµ„

è³‡æ–™ä¾è³´ï¼š
- å¿…é ˆç”± A å·¥å» å…ˆè¡Œè¨ˆç®—
- ä½¿ç”¨ A å·¥å» è¼¸å‡ºçš„ B7ï¼ˆå°å¾‘ X èµ·é»ï¼‰

è¼¸å‡ºï¼š
- E2 ~ E6ï¼šå°é½Š Excel / åŠ å·¥åœ–é¢çš„é—œéµåº§æ¨™èˆ‡åŠå¾‘
- çµ±ä¸€èˆªæ¯æ ¼å¼ï¼ˆvalues + text_linesï¼‰
============================================================
"""

import math


# -------------------------------------------------------
# ğŸ”§ é¡¯ç¤ºç”¨æ ¼å¼åŒ–å·¥å…·
# -------------------------------------------------------
def _fmt(x, p=6):
    """
    æ•¸å€¼é¡¯ç¤ºæ ¼å¼åŒ–
    - é è¨­å°æ•¸é»å¾Œ 6 ä½
    - None å‰‡é¡¯ç¤ºç‚º "-"
    """
    return f"{x:.{p}f}" if x is not None else "-"


# -------------------------------------------------------
# ğŸ§  æ ¸å¿ƒè¨ˆç®—ï¼ˆC å·¥å» ï¼‰
# -------------------------------------------------------
def solve_c(data):
    """
    C å·¥å» ä¸»é‹ç®—æµç¨‹

    è¼¸å…¥ dataï¼ˆ
    - data["A"]["B7"]        â†’ å‰ç«¯å°å¾‘ X èµ·é»
    - data["è§’åº¦"]           â†’ æ–œè§’è§’åº¦
    - data["å‰ç«¯xè»¸å¤–å¾‘"]     â†’ å¤–å¾‘ï¼ˆç›´å¾‘ï¼‰
    - data["æœªç«¯Rè§’"]        â†’ çµ‚é» R
    - data["åˆ€é¼»åŠå¾‘"]        â†’ åˆ€é¼»åŠå¾‘

    è¼¸å‡ºï¼š
    - E2, E3ï¼šçµ‚é» R èµ·å§‹é»
    - E4, E5ï¼šçµ‚é» R çµæŸé»
    - E6     ï¼šåˆ€é¼»è£œæ­£å¾Œåœ“å¼§ R
    """

    # ===================================================
    # ğŸ”¥ A å·¥å» è³‡æ–™æ³¨å…¥
    # ---------------------------------------------------
    # A å·¥å» å·²å…ˆè¨ˆç®—å®Œæˆï¼Œä¸¦å°‡ B7 å¯«å…¥ data["A"]
    # B7 æ˜¯æœ¬å·¥å» çš„ã€Œå¹¾ä½•èµ·é»ã€
    # ===================================================
    A_values = data.get("A", {})
    B7 = A_values.get("B7")

    # ===================================================
    # 1ï¸âƒ£ è®€å–ä¸¦æ•´ç†è¼¸å…¥ï¼ˆå°é½Š Excel B æ¬„ï¼‰
    # ===================================================
    B2 = float(B7)                           # å°å¾‘ Xï¼ˆA å·¥å» ï¼‰
    B3 = float(data["è§’åº¦"])                 # æ–œè§’è§’åº¦ï¼ˆdegï¼‰
    B4 = float(data["å‰ç«¯xè»¸å¤–å¾‘"]) / 2       # å¤–å¾‘åŠå¾‘
    B5 = float(data["æœªç«¯Rè§’"])              # çµ‚é» R
    B6 = float(data["åˆ€é¼»åŠå¾‘"]) * 2          # åˆ€é¼»ç›´å¾‘
    B8 = 0.0                                 # å¹³ç·š Z = 0ï¼ˆå›ºå®šï¼‰

    # ===================================================
    # 2ï¸âƒ£ æ–œç·šåŸºæœ¬åƒæ•¸ï¼ˆå®Œå…¨æ²¿ç”¨åŸå·¥å» å…¬å¼ï¼‰
    # ===================================================
    B10 = -math.tan(math.radians(B3))        # æ–œç·šæ–œç‡
    B11 = B2 - B10 * B8                      # æ–œç·šæˆªè·
    B12 = math.sqrt(1.0 + B10**2)            # æ³•å‘é‡é•·åº¦

    B13 = B6 / 2.0                           # åˆ€é¼»åŠå¾‘
    B14 = B5 + B13                           # R + åˆ€é¼»
    B16 = B4 - B5                            # çµ‚é» R åœ“å¿ƒ X

    # ===================================================
    # 3ï¸âƒ£ ç¬¬ä¸€å€‹åœ“ï¼šæ–œç·š Ã— çµ‚é» Rï¼ˆæœªè£œæ­£ï¼‰
    # ---------------------------------------------------
    # è§£ç›´ç·šèˆ‡åœ“çš„äº¤é»ï¼Œå–æ­£ç¢ºæ¥è§¸é»
    # ===================================================
    B17 = (B16 - B11 + B5 * B12) / B10
    B20 = 1.0 + B10**2
    B21 = 2.0 * (B10 * (B11 - B16) - B17)
    B22 = B17**2 + (B11 - B16)**2 - B5**2
    B23 = B21**2 - 4.0 * B20 * B22
    sqrt_B23 = math.sqrt(max(0.0, B23))

    B24 = (-B21 - sqrt_B23) / (2.0 * B20)
    B25 = (-B21 + sqrt_B23) / (2.0 * B20)
    B26 = B10 * B24 + B11
    B27 = B10 * B25 + B11

    # é¸æ“‡æ­£ç¢ºçš„äº¤é»
    if B24 < B25:
        B28, B29 = B24, B26
    else:
        B28, B29 = B25, B27

    # ===================================================
    # 4ï¸âƒ£ ç¬¬äºŒå€‹åœ“ï¼šåˆ€é¼»è£œæ­£å¾Œåœ“
    # ---------------------------------------------------
    # èˆ‡ç¬¬ä¸€å€‹åœ“æ¥çºŒï¼Œç”¨è·é›¢åˆ¤æ–·æ­£ç¢ºè§£
    # ===================================================
    B32 = B11 + B13 * B12
    B33 = 1.0 + B10**2
    B34 = 2.0 * (B10 * (B32 - B16) - B17)
    B35 = B17**2 + (B32 - B16)**2 - B14**2
    B36 = B34**2 - 4.0 * B33 * B35
    sqrt_B36 = math.sqrt(max(0.0, B36))

    B37 = (-B34 - sqrt_B36) / (2.0 * B33)
    B38 = (-B34 + sqrt_B36) / (2.0 * B33)
    B39 = B10 * B37 + B32
    B40 = B10 * B38 + B32

    # ===================================================
    # 5ï¸âƒ£ E2, E3ï¼šçµ‚é» R èµ·å§‹é»
    # ---------------------------------------------------
    # ä»¥è·é›¢åˆ¤æ–·èˆ‡ç¬¬ä¸€åœ“éŠœæ¥æœ€åˆç†è€…
    # ===================================================
    d1 = (B37 - B28)**2 + (B39 - B29)**2
    d2 = (B38 - B28)**2 + (B40 - B29)**2
    
    B51 = B37 if d1 <= d2 else B38
    B41 = B51-B13

    B52 = B39 if abs(B51 - B37) < 1e-12 else B40
    B42 = (B52-B13)*2
    # ===================================================
    # 6ï¸âƒ£ E4, E5ï¼šçµ‚é» R çµæŸé»ï¼ˆå¹³ç·šï¼‰
    # ===================================================
    B55 = B4 + B13                           # çµ‚é» X
    B45 = (B55-B13)*2
    inside = max(0.0, B14**2 - (B55 - B16)**2)
    B56 = B17 - math.sqrt(inside)            # çµ‚é» Z
    B46 = B56-B13
    B47 = B5 + (B6 / 2)                      # åˆ€é¼»è£œæ­£å¾Œ R
    
    # ===================================================
    # 7ï¸âƒ£ èˆªæ¯çµ±ä¸€è¼¸å‡º
    # ===================================================
    result_values = {
        "E2": B41,
        "E3": B42,
        "E4": B46,
        "E5": B45,
        "E6": B47
    }

    text_lines = [
        "â¡ï¸ å‰ç«¯æ–œè§’ â†’ å¹³ç·š â†’ çµ‚é»å¼§ï¼ˆC å·¥å» ï¼‰",
        f"E2 = {_fmt(B41)}",
        f"E3 = {_fmt(B42)}",
        f"E4 = {_fmt(B46)}",
        f"E5 = {_fmt(B45)}",
        f"E6 = {_fmt(B47)}",
    ]

    return {
        "ok": True,
        "text_lines": text_lines,
        "values": result_values
    }
def solve(data: dict):
    return solve_c(data)