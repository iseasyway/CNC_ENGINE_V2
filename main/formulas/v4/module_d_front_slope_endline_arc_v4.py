# -*- coding: utf-8 -*-

import math


# -------------------------------------------------------
# ğŸ”§ é¡¯ç¤ºç”¨æ ¼å¼åŒ–å·¥å…·
# -------------------------------------------------------
def _fmt(x, p=6):
    """
    æ•¸å€¼é¡¯ç¤ºæ ¼å¼åŒ–
    - é è¨­å°æ•¸é»å¾Œ 6 ä½
    - None å‰‡é¡¯ç¤ºç‚º "-"
    """
    return f"{x:.{p}f}" if x is not None else "-"


# -------------------------------------------------------
# ğŸ§  æ ¸å¿ƒè¨ˆç®—ï¼ˆC å·¥å» ï¼‰
# -------------------------------------------------------
def solve_d(data):

    # ===================================================
    # 1ï¸âƒ£ è®€å–ä¸¦æ•´ç†è¼¸å…¥ï¼ˆå°é½Š Excel B æ¬„ï¼‰
    # ===================================================
    K1 = float(data["çµ‚é»xè»¸å¤–å¾‘"])/2         # å°å¾‘ Xï¼ˆA å·¥å» ï¼‰
    
    K2 = float(data.get("æ–œåº¦é•·W2", 999))           # Z_A
    K3 = float(data["å‰ç«¯xè»¸å¤–å¾‘"])/2       # X_Bï¼ˆåŠå¾‘ï¼‰
    K4 = float(data["æ–œåº¦è§’"])               # è§’åº¦ï¼ˆdegï¼‰
    K5 = float(data["åˆ€é¼»åŠå¾‘"])          # åˆ€é¼»ç›´å¾‘
    K6 = float(data["zè»¸é•·åº¦"])          
    # ===================================================
    # 2ï¸âƒ£ è¼”åŠ©å‡½å¼ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºç©ºå€¼
    # ===================================================
    def is_blank(v):
        return v in (None, "", 999, -999)

    # ===================================================
    # 3ï¸âƒ£ è¼¸å…¥ç‹€æ…‹åˆ¤æ–·
    # ===================================================
    
    has_ZA = not is_blank(K2)
    has_XB = not is_blank(K3)

    if not has_ZA and not has_XB:
        raise ValueError("âŒ K2(Z_A) èˆ‡ K3(X_B) è‡³å°‘éœ€è¼¸å…¥ä¸€å€‹")

    if has_ZA and has_XB:
        raise ValueError("âŒ K2(Z_A) èˆ‡ K3(X_B) åªèƒ½è¼¸å…¥ä¸€å€‹")

    # ===================================================
    # 4ï¸âƒ£ åŸºæº–èˆ‡è§’åº¦
    # ===================================================
    X_A = K1
    r = K5
    theta = K4

    theta_eff = 90.0 - theta
    tt = math.tan(math.radians(theta_eff))

    # ===================================================
    # 5ï¸âƒ£ è£œç®— Z_A
    # ===================================================
    if has_ZA:
        # æ¨¡å¼ Aï¼šç›´æ¥ç”¨ Z
        Z_A = float(K2)
        src = "ä½¿ç”¨ K2(Z_A)"

    else:
        # æ¨¡å¼ Bï¼šç”± X åæ¨ Z
        X_B = float(K3)
        Z_A = -abs(X_A - X_B) * tt
        src = "ä½¿ç”¨ K3(X_B) â†’ åæ¨ Z_A"

        # --- è§’åº¦è½‰æ› ---
        theta_eff = 90.0 - theta
        th = math.radians(theta_eff)

        tt = math.tan(th)
        st = math.sin(th)
        ct = math.cos(th)

        # --- B é» ---
        X_B = X_A - abs(Z_A) / tt
        Z_B = 0.0

        # --- åœ“å¿ƒâ‘ ï¼šZ=0 ---
        E2_Z = r
        E2_X = X_B + (r - (E2_Z - Z_B) * ct) / st

        # --- åœ“å¿ƒâ‘¡ï¼šX=X_A ---
        E4_X = X_A + r
        E4_Z = Z_A + (r - (E4_X - X_A) * st) / ct
        D43 = (E4_X-K5)*2
        D44 = (E4_Z-K6)-K5
    # ===================================================
    # 6ï¸âƒ£ çµ±ä¸€è¼¸å‡º
    # ===================================================
    result_values = {
        "D41": E2_X,
        "D42": E2_Z,
        "D43": D43,
        "D44": D44,
    }

    text_lines = [
        "â¡ï¸ å‰ç«¯æ–œè§’ â†’ å¹³ç·š â†’ çµ‚é»å¼§ï¼ˆC å·¥å» ï¼‰",
        f"D41 = {_fmt(E2_X)}",
        f"D42 = {_fmt(E2_Z)}",
        f"D43 = {_fmt(E4_X)}",
        f"D44 = {_fmt(E4_Z)}",
    ]

    return {
        "ok": True,
        "text_lines": text_lines,
        "values": result_values,
    }


# -------------------------------------------------------
# ğŸ” å°å¤–çµ±ä¸€ä»‹é¢
# -------------------------------------------------------
def solve(data: dict):
    return solve_d(data)

