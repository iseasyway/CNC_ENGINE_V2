# -*- coding: utf-8 -*-
"""
module_a_escape_groove_v2.py
============================================================
ğŸ­ V2 - A å·¥å» ï½œEscape Grooveï¼ˆæœ€çµ‚æ­£å¼ç‰ˆï¼‰

â˜… æœ€é‡è¦æ›´æ–°ï¼ˆ100% æ­£ç¢ºï¼‰ï¼š
  - æ‰€æœ‰æ›ç®—éƒ½ä½¿ç”¨ã€Œæ–œåº¦é•· W = Lã€ä½œç‚ºä¸»å…¬å¼
  - A æ¨¡å¼ï¼šç›´æ¥ç”¨ K4 = W
  - B æ¨¡å¼ï¼šK6 = åº•éƒ¨ç›´å¾‘ Xï¼Œåªè² è²¬åæ¨ W
  - å†æŠŠ W ä¸Ÿé€² solve_escape_grooveï¼ˆA æ¨¡å¼ä¸»å…¬å¼ï¼‰
  â†’ å› æ­¤ A / B æ¨¡å¼æ°¸é ç®—å‡ºä¸€æ¨£çµæœï¼ˆä¾‹å¦‚ 28.507ï¼‰
============================================================
"""

import math

DISPLAY_DECIMALS = 3


# ----------------------------------------------------------
# A æ¨¡å¼ä¸»å…¬å¼ï¼ˆä½  formulas.py çš„åŸç‰ˆï¼Œä¸æ”¹ï¼‰
# ----------------------------------------------------------
def solve_escape_groove(R_big, theta_deg, z_safe, L, r):
    th = math.radians(abs(theta_deg))
    ct = math.cos(th)
    tt = math.tan(th)

    # åŠå¾‘ç³»çµ±
    D2 = r + r * tt - r / ct + z_safe * tt
    D3 = R_big - (L * tt + D2)

    B51 = D3 * 2              # è½‰æˆç›´å¾‘
    
    D4  = z_safe
    return B51, D4


# ----------------------------------------------------------
# V2 ä¸»å…¥å£
# ----------------------------------------------------------
def solve(data: dict):

    # ========= è®€å– =========
    K1 = float(data.get("K1"))  # èµ·å§‹ç›´å¾‘ï¼ˆä¾‹ 40ï¼‰
    K2 = float(data.get("K2"))  # è§’åº¦ï¼ˆä¾‹ 30Â°ï¼‰
    K3 = float(data.get("K3"))  # Z å®‰å…¨è·é›¢ï¼ˆä¾‹ 1ï¼‰
    K4 = data.get("K4")         # æ–œåº¦é•· Wï¼ˆä¾‹ 8.660ï¼‰
    K5 = float(data.get("K5"))  # åˆ€é¼»åŠå¾‘ï¼ˆä¾‹ 0.4ï¼‰
    K6 = data.get("K6")         # åº•éƒ¨ç›´å¾‘ Xï¼ˆä¾‹ 30ï¼‰

    def used(v):
        return v not in (None, "", 999)

    has_K4 = used(K4)
    has_K6 = used(K6)

    if has_K4 and has_K6:
        raise ValueError("K4 å’Œ K6 ä¸å¯åŒæ™‚è¼¸å…¥")
    if not has_K4 and not has_K6:
        raise ValueError("K4 å’Œ K6 å¿…é ˆè¼¸å…¥å…¶ä¸­ä¸€å€‹")

    # å…±ç”¨åƒæ•¸
    R_big = K1 / 2
    theta_deg = K2
    z_safe = K3
    r = K5

    # ç”¨ä¾†åæ¨ W çš„ä¸‰è§’åƒæ•¸
    th = math.radians(abs(theta_deg))
    tt = math.tan(th)

    # ============================================================
    # â­â­â­ A æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ K4 = Wï¼ˆå®Œå…¨æ­£ç¢ºï¼‰
    # ============================================================
    if has_K4:
        W = float(K4)
        mode = "A æ¨¡å¼ï¼šæ–œåº¦é•· W (K4)"

    # ============================================================
    # â­â­â­ B æ¨¡å¼ï¼šK6 = åº•éƒ¨ç›´å¾‘ X â†’ å…ˆåæ¨ Wï¼Œå†èµ°ä¸»å…¬å¼
    # ============================================================
    else:
        D_bottom = float(K6)   # ä¾‹ 30
        D_start  = K1          # ä¾‹ 40

        # ç›´å¾‘ä¸‹é™é‡ï¼ˆä¾‹ï¼š40 â†’ 30 = 10ï¼‰
        Î”D = D_start - D_bottom

        # â­ åæ¨æ–œåº¦é•· Wï¼ˆé‡é»ï¼‰
        # Î”D = 2 * W * tanÎ¸  â†’ W = Î”D / (2*tanÎ¸)
        W = Î”D / (2 * tt)
        mode = "B æ¨¡å¼ï¼šåº•éƒ¨ç›´å¾‘ X (K6)"

    # ============================================================
    # â­â­â­ æœ€çµ‚ï¼šå…¨éƒ¨éƒ½ä½¿ç”¨åŒä¸€å€‹ä¸»å…¬å¼ solve_escape_groove
    # ============================================================
    B51, D4 = solve_escape_groove(
        R_big=R_big,
        theta_deg=theta_deg,
        z_safe=z_safe,
        L=W,
        r=r
    )

    return {
        "ok": True,
        "values": {
            "B51": B51,
            "D4":  D4,
            "L":   W,    # W = L
            "K1": K1, 
            
        },
        "text_lines": [
            "A å·¥å»  Escape Groove v2ï¼ˆæ­£å¼ç‰ˆï¼‰å®Œæˆ",
            f"æ¨¡å¼ï¼š{mode}",
            f"K1  = {K1:.3f}",
            f"W/L = {W:.3f}",
            f"B51 = {B51:.3f}",
            f"D4  = {D4:.3f}",
        ]
    }
