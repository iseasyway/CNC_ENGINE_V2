# -*- coding: utf-8 -*-
"""
v1_solver.py â€” èˆªæ¯ä¸»æ§ç‰ˆï¼ˆæœ¬åœ° / Web é€šç”¨ï¼‰
============================================================
è§’è‰²å®šä½ï¼š
- V1 å¹¾ä½•ç³»çµ±çš„ã€Œå¯¦æˆ°ä¸»æ§èˆªæ¯ã€
- å¯ç”¨æ–¼ï¼š
  1ï¸âƒ£ æœ¬åœ° Terminal æ¸¬è©¦ï¼ˆprint è¼¸å‡ºï¼‰
  2ï¸âƒ£ Web / API å‘¼å«ï¼ˆHTML è¼¸å‡ºï¼‰

è¨­è¨ˆé‡é»ï¼š
- æ•´åˆå››å¤§å¹¾ä½•å·¥å» ï¼šA / B / C / D
- æ¸…æ¥šå®šç¾©å·¥å» åŸ·è¡Œé †åºèˆ‡è³‡æ–™ä¾è³´
- åŒä¸€å¥—é‚è¼¯ï¼ŒåŒæ™‚æ”¯æ´ã€Œäººçœ‹ã€èˆ‡ã€Œå‰ç«¯é¡¯ç¤ºã€
============================================================
"""

import importlib

# ==========================================================
# ğŸ“¦ ç›´æ¥åŒ¯å…¥ V1 å››å¤§åŠ å·¥å» ï¼ˆç©©å®šç‰ˆï¼‰
# ----------------------------------------------------------
# èªªæ˜ï¼š
# - é€™æ”¯ solver æ˜¯ã€Œå¯¦æˆ°ç©©å®šç‰ˆã€
# - ä¸èµ°å‹•æ…‹ç‰ˆæœ¬åˆ‡æ›
# - æ˜ç¢ºæŒ‡å®š v1 å…¬å¼æ¨¡çµ„
# ==========================================================
from main.formulas.v1 import module_a_front_fillet
from main.formulas.v1 import module_b_outer_perp_R
from main.formulas.v1 import module_c_front_slope_endline_arc_v1
from main.formulas.v1 import module_d_angle_to_z_offset


# ==========================================================
# ğŸ§  ä¸»é‹ç®—æµç¨‹ï¼šä¾åºåŸ·è¡Œ A â†’ B â†’ C â†’ D
# ==========================================================
def run_all_modules(data):
    """
    ä¸»é‹ç®—æµç¨‹ï¼ˆCLI / Debug å°ˆç”¨ï¼‰ï¼š

    è¼¸å…¥ï¼š
    - dataï¼šå‰ç«¯æˆ–æœ¬åœ°æä¾›çš„åƒæ•¸ dict

    ç‰¹é»ï¼š
    - é€å·¥å»  print è¨ˆç®—éç¨‹
    - é©åˆåœ¨ Terminal / é–‹ç™¼éšæ®µæª¢æŸ¥æ•¸å€¼
    """

    results = {}

    print("\n=== ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰å¹¾ä½•å·¥å»  ===\n")

    # -------------------------------
    # ğŸ­ A å·¥å» 
    # -------------------------------
    # åŠŸèƒ½ï¼š
    # - å‰ç«¯ R è§’ + æ–œåº¦å¹¾ä½•å»ºç«‹
    # - ç”¢ç”Ÿå¾ŒçºŒ C å·¥å» æ‰€éœ€åŸºæº–é»
    print("ã€Aã€‘å‰ç«¯ Rè§’æ–œåº¦è¨ˆç®—ï¼š")
    res_a = module_a_front_fillet.solve_a(data)

    # å°‡ A å·¥å» è¨ˆç®—éç¨‹é€è¡Œå°å‡º
    for line in res_a["text_lines"]:
        print("   " + line)

    # åªæ”¶é›† values ä½œç‚ºæ­£å¼çµæœ
    results["A"] = res_a["values"]
    print()


    # -------------------------------
    # ğŸ­ B å·¥å» 
    # -------------------------------
    # åŠŸèƒ½ï¼š
    # - å¤–å¾‘å‚ç›´ç«¯
    # - åœ“å¼§ / R è£œæ­£ç›¸é—œå¹¾ä½•
    print("ã€Bã€‘å¤–å¾‘å‚ç›´ç«¯ R è¨ˆç®—ï¼š")
    res_b = module_b_outer_perp_R.solve(data)

    for line in res_b["text_lines"]:
        print("   " + line)

    results["B"] = res_b["values"]
    print()


    # -------------------------------
    # ğŸ­ C å·¥å» ï¼ˆä¾è³´ A å·¥å» çµæœï¼‰
    # -------------------------------
    # åŠŸèƒ½ï¼š
    # - æ–œè§’ â†’ å¹³ç·š â†’ çµ‚é»åœ“å¼§
    # - éœ€è¦ A å·¥å» ç”¢ç”Ÿçš„é—œéµå¹¾ä½•ï¼ˆå¦‚ B7ï¼‰
    print("ã€Cã€‘æ–œè§’ â†’ å¹³ç·š â†’ çµ‚é»å¼§ è¨ˆç®—ï¼š")

    # å°‡ A å·¥å» çµæœå¯«å› dataï¼Œä¾› C ä½¿ç”¨
    data["A"] = results["A"]

    res_c = module_c_front_slope_endline_arc_v1.solve(data)

    for line in res_c["text_lines"]:
        print("   " + line)

    results["C"] = res_c["values"]
    print()


    # -------------------------------
    # ğŸ­ D å·¥å» 
    # -------------------------------
    # åŠŸèƒ½ï¼š
    # - è§’åº¦ â†’ Z è»¸è·é›¢
    # - å°æ‡‰ Excel B14 é¡å‹çš„å¹¾ä½•è£œæ­£
    print("ã€Dã€‘è§’åº¦ Zè»¸è·é›¢ B14ï¼š")

    res_d = module_d_angle_to_z_offset.solve(data)

    for line in res_d["text_lines"]:
        print("   " + line)

    results["D"] = res_d["values"]
    print()

    print("=== âœ… æ‰€æœ‰å·¥å» å®Œæˆ ===")
    return results


# ==========================================================
# ğŸŒ Web å°ˆç”¨è¼¸å‡ºï¼ˆçµæœ â†’ HTML å­—ä¸²ï¼‰
# ==========================================================
def run_all_modules_with_output(data):
    """
    Web / API å°ˆç”¨å…¥å£ï¼š

    åŠŸèƒ½ï¼š
    - é‡æ–°è¼‰å…¥æ‰€æœ‰å·¥å» ï¼ˆé–‹ç™¼ç†±æ›´æ–°ï¼‰
    - å‘¼å« run_all_modules å–å¾—å®Œæ•´çµæœ
    - å°‡çµæœæ•´ç†ç‚ºã€Œå‰ç«¯å¯ç›´æ¥é¡¯ç¤ºçš„æ–‡å­—æ ¼å¼ã€
    """

    # ------------------------------------------------------
    # ğŸ”„ ç†±æ›´æ–°å››å¤§å·¥å» ï¼ˆé¿å…é‡å•Ÿä¼ºæœå™¨ï¼‰
    # ------------------------------------------------------
    importlib.reload(module_a_front_fillet)
    importlib.reload(module_b_outer_perp_R)
    importlib.reload(module_c_front_slope_endline_arc_v1)
    importlib.reload(module_d_angle_to_z_offset)

    # åŸ·è¡Œå®Œæ•´å¹¾ä½•é‹ç®—
    results = run_all_modules(data)

    # ä¾å·¥å» æ‹†å‡ºçµæœ
    A = results.get("A", {})
    B = results.get("B", {})
    C = results.get("C", {})
    D = results.get("D", {})

    # ------------------------------------------------------
    # å®‰å…¨å–å€¼å·¥å…·ï¼ˆé¿å… KeyErrorï¼‰
    # ------------------------------------------------------
    def g(dic, key, default=0):
        return dic.get(key, default)

    # ------------------------------------------------------
    # çµ„åˆå‰ç«¯é¡¯ç¤ºæ–‡å­—ï¼ˆç­‰åŒ Excel è¼¸å‡ºè¡¨ï¼‰
    # ------------------------------------------------------
    html = ""
    html += "=== ğŸ§© åˆ€é»åº§æ¨™ç¸½è¡¨ ===\n\n"

    # ===== å‰ç«¯ R è§’ =====
    html += f"å‰ç«¯Rè§’èµ·å§‹é»      X={g(A,'B21'):.3f}\n"
    html += f"å‰ç«¯Rè§’èµ·å§‹é»      Z={g(A,'B22'):.3f}\n\n"

    html += f"å‰ç«¯Rè§’çµ‚é»        X={g(A,'B42'):.3f}\n"
    html += f"å‰ç«¯Rè§’çµ‚é»        Z={g(A,'B43'):.3f}\n"
    html += f"å‰ç«¯Rè§’åˆ€é¼»è£œæ­£    R={g(A,'B44'):.3f}\n\n"

    # ===== æœªç«¯ R è§’ =====
    html += f"æœªç«¯Rè§’èµ·å§‹é»      X={g(C,'E3'):.3f}\n"
    html += f"æœªç«¯Rè§’èµ·å§‹é»      Z={g(C,'E2'):.3f}\n\n"

    html += f"æœªç«¯Rè§’çµ‚é»        X={g(C,'E5'):.3f}\n"
    html += f"æœªç«¯Rè§’çµ‚é»        Z={g(C,'E4'):.3f}\n"
    html += f"åˆ€é¼»è£œæ­£å¾Œåœ“å­¤     R={g(C,'E6'):.3f}\n\n"

    # ===== å¤–å¾‘åœ“å¼§è£œæ­£ =====
    html += f"åœ“å­¤Rå‰ç«¯          X={g(B,'OUT_E4'):.3f}\n"
    html += f"åœ“å­¤Rå‰ç«¯          Z=-{g(B,'OUT_E3'):.3f}\n\n"
    html += f"åœ“å­¤å¾Œxåº§æ¨™:       X={g(B,'OUT_E7'):.3f}\n"
    html += f"åœ“å­¤å¾Œzåº§æ¨™:       Z=-{g(B,'OUT_E6'):.3f}\n"
    html += f"åˆ€é¼»è£œæ­£å¾Œåœ“å­¤:    R={g(B,'OUT_E9'):.3f}\n\n"

    html += "=== ğŸŸ¢ å¹¾ä½•é‹ç®—å®Œæˆ ==="

    return html
