# -*- coding: utf-8 -*-
"""
v2_master_solver.py
============================================================
ğŸ§  èˆªæ¯ä¸­å¤®å¤§è…¦ï¼ˆV2 ç‰ˆæœ¬ï¼‰

è§’è‰²å®šä½ï¼š
- ä½œç‚º V2 å¹¾ä½•è¨ˆç®—çš„ã€Œå”¯ä¸€ç¸½å…¥å£ã€
- çµ±ä¸€èª¿åº¦ V2 æ¨¡çµ„ï¼ˆmodule_a / module_bï¼‰
- æ§åˆ¶æ¨¡çµ„åŸ·è¡Œé †åºèˆ‡è³‡æ–™æµå‘
- æä¾› app.py / router å‘¼å«çš„ç©©å®šä»‹é¢

è¨­è¨ˆåŸå‰‡ï¼š
- æœ¬æª”æ¡ˆä¸å¯«ä»»ä½•å¹¾ä½•å…¬å¼
- ä¸ç›¸ä¾ v1 æ¨¡çµ„
- åªè² è²¬ã€Œèª¿åº¦ã€ä¸²æ¥ã€æ•´åˆã€
============================================================
"""

import importlib

# ------------------------------------------------------
# ğŸ”§ æŒ‡å®šç›®å‰ä½¿ç”¨çš„å…¬å¼ç‰ˆæœ¬ï¼ˆV2ï¼‰
# ------------------------------------------------------
FORMULA_VERSION = "v2"
formula_path = f"main.formulas.{FORMULA_VERSION}"


# ------------------------------------------------------
# ğŸ“¦ å‹•æ…‹åŒ¯å…¥ V2 æ¨¡çµ„ï¼ˆåªå‰© A / Bï¼‰
# ------------------------------------------------------
module_a = importlib.import_module(
    f"{formula_path}.module_a_escape_groove_v2"
)
module_b = importlib.import_module(
    f"{formula_path}.module_b_simple_arc_v2"
)


# ==========================================================
# ğŸ§  ä¸»é‹ç®—æµç¨‹ï¼šæ•´åˆ A â†’ B
# ==========================================================
def run_all_modules(user_inputs: dict):
    """
    ä¸»é‹ç®—æµç¨‹ï¼ˆV2ï¼‰ï¼š

    è¼¸å…¥ï¼š
    - user_inputsï¼šç”±å‰ç«¯å‚³å…¥çš„åŸå§‹åƒæ•¸ dict

    æµç¨‹ï¼š
    1ï¸âƒ£ è¤‡è£½è¼¸å…¥è³‡æ–™ï¼Œé¿å…æ±¡æŸ“åŸå§‹è³‡æ–™
    2ï¸âƒ£ åŸ·è¡Œ A â†’ B
    3ï¸âƒ£ æ”¶é›†å„æ¨¡çµ„å›å‚³çš„ values
    4ï¸âƒ£ å›å‚³å®Œæ•´çµæœ dict

    è¼¸å‡ºï¼š
    - results = {
        "A": {...},
        "B": {...}
      }
    """

    # --------------------------------------------------
    # å»ºç«‹å…§éƒ¨è³‡æ–™å‰¯æœ¬
    # --------------------------------------------------
    data = user_inputs.copy()

    results = {}

    # --------------------------
    # ğŸ­ A æ¨¡çµ„ï¼ˆEscape Grooveï¼‰
    # --------------------------
    res_a = module_a.solve(data)
    results["A"] = res_a.get("values", {})

    # è‹¥ B éœ€è¦ A çš„çµæœï¼ˆä¿ç•™æ“´å……å½ˆæ€§ï¼‰
    data["A"] = results["A"]

    # --------------------------
    # ğŸ­ B æ¨¡çµ„ï¼ˆSimple Arcï¼‰
    # --------------------------
    res_b = module_b.solve(data)
    results["B"] = res_b.get("values", {})

    return results


# ==========================================================
# ğŸ”¥ çµ±ä¸€è¼¸å‡ºæ ¼å¼ï¼ˆçµæœ dict â†’ HTMLï¼‰
# ==========================================================
def _render_output_v2(results: dict) -> str:

    A = results.get("A", {})
    B = results.get("B", {})


    L_value = A.get("L", 0)       # A å·¥å» çš„ L
    B51_value = B.get("B51", 0)   # B å·¥å» çš„ B51
    # è¨ˆç®—å·®å€¼
    diff_L_B51 = L_value + B51_value
    # å­˜æˆæ–°çš„çµæœ
    results["AB"] = {
    "L_minus_B51": diff_L_B51
    }


    def g(dic, key, default=0):
        return dic.get(key, default)

    html = ""
    html += "=== ğŸ§© åˆ€é»åº§æ¨™ç¸½è¡¨ ===\n\n"

    # ===========================
    #      A å·¥å» ï¼ˆEscape Grooveï¼‰
    # ===========================
    html += f"G0 X{g(A,'B51'):.3f}ğŸ”´\n"
    html += f"G0 Z{g(A,'D4'):.3f}ğŸ”´\n"
    

    # ===========================
    #      B å·¥å» ï¼ˆSimple Arcï¼‰
    # ===========================
  
    #html += f"B51 = {g(B,'B51'):.3f}\n\n"

    AB = results.get("AB", {})
    html += f"G1 X{g(A,'K1'):.3f} Z-{AB.get('L_minus_B51', 0):.3f} F0.1ğŸŸ¡\n\n"
    html += "=== ğŸŸ¢ V2 å¹¾ä½•é‹ç®—å®Œæˆ ==="

    return html


# ==========================================================
# ğŸ›  é–‹ç™¼æ¨¡å¼ï¼šå‹•æ…‹ç†±æ›´æ–°
# ==========================================================
def reload_all():
    """
    é‡æ–°è¼‰å…¥ V2 æ¨¡çµ„
    ï¼ˆé–‹ç™¼éšæ®µä½¿ç”¨ï¼Œé¿å…é‡å•Ÿ FastAPIï¼‰
    """
    importlib.reload(module_a)
    importlib.reload(module_b)
# ==========================================================
# ğŸŒ Web / API å°ˆç”¨å…¥å£ï¼ˆV2ï¼‰
# ==========================================================
def run_all_v2_modules_with_output(data: dict) -> str:
    results = run_all_modules(data)
    return _render_output_v2(results)
